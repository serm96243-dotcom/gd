{
  "title": "Мониторинг",
  "text": "Была ли статья полезной?\nДа\nНет\nСпасибо за вашу оценку!\nОставляя более подробный отзыв, вы помогаете нам улучшать документацию\nКомментарий к оценке\nКонтактная информация (необязательно)\nВложения\nДобавить файл\nОтменить\nОтправить\nМониторинг\n1. Мониторинг приложения\n1.1. Как это устроено\nВ приложение встроен экспортер метрик, который собирает данные о работе приложения.\nЭкспортер работает всегда, загружается одновременно с приложением.\nЧтобы Prometheus мог забрать метрики, нужно настроить приложение,\nнастройка производится в конфигурационном файле app.yml.\nПосле настройки приложения, можно переходить к настройке\nPrometheus\nдля извлечения данных приложения.\nДля визуализации метрик будет использована Grafana.\n1.2. Проверка доступности приложения\nДля проверки доступности приложения, в консоли нужно выполнить такую команду:\ncurl http://localhost:8080/health\n{\"status\":\"UP\"}\nshell\nCopied!\n1.3. Настройка приложения для передачи метрик\nЧтобы\nPrometheus\nмог забрать данные приложения, последнее нужно настроить,\nконфигурация приложения находится в файле app.yml и будет выглядеть следующим образом:\nmanagement:\nmetrics:\nexport:\nprometheus:\nenabled:\ntrue\ndistribution:\npercentiles-histogram:\n\"[http.server.requests]\"\n:\ntrue\nendpoints:\nweb:\nexposure:\n# подсказка, если вы хотите разрешить какую-то конечную точку, вам следует:\n# 1. добавьте ее в поле include\n# 2. удалите ее из списка exclude\n# 3. добавьте его в pro.greendata.core.web.util.SaasUtils.ignoringFilterUris\ninclude:\nhealth,\nprometheus\n# исключить все кроме health и prometheus\nexclude:\nauditevents,beans,caches,conditions,configprops,env,flyway,heapdump,httptrace,info,integrationgraph,jolokia,logfile,loggers,liquibase,metrics,mappings,quartz,scheduledtasks,sessions,shutdown,startup,threaddump\nbase-path:\n/\njmx:\nexposure:\nexclude:\n'*'\nyaml\nCopied!\nПосле этого нужно перезапустить приложение и проверить доступность метрик,\nдля этого нужно ввести в браузере адрес следующего типа:\n#Для HTTP\nhttp://АДРЕС\n_ПРИЛОЖЕНИЯ:ПОРТ_\nПРИЛОЖЕНИЯ/prometheus\n#Для HTTPS\nhttps://АДРЕС\n_ПРИЛОЖЕНИЯ/prometheus\nasciidoc\nCopied!\nПосле чего можно увидеть все метрики, которые будут доступны для\nPrometheus\n.\nПорт по которому\nPrometheus\nможет забрать метрики приложения, может быть изменен.\nДля изменения порта нужно добавить настройку\nmanagement.server.port\nв файл app.yml.\nНастройка будет выглядеть следующим образом:\nmanagement:\nmetrics:\nexport:\nprometheus:\nenabled:\ntrue\ndistribution:\npercentiles-histogram:\n\"[http.server.requests]\"\n:\ntrue\nendpoints:\nweb:\nexposure:\ninclude:\nhealth,\nprometheus\nexclude:\nauditevents,beans,caches,conditions,configprops,env,flyway,heapdump,httptrace,info,integrationgraph,jolokia,logfile,loggers,liquibase,metrics,mappings,quartz,scheduledtasks,sessions,shutdown,startup,threaddump\nbase-path:\n/\njmx:\nexposure:\nexclude:\n'*'\nserver:\nport:\nYOUR_PORT\nyaml\nCopied!\n1.4. Настройка Prometheus для извлечения данных приложения\nДля возможности извлечения данных приложения, нужно настроить конфигурационный файл prometheus.yml,\nконфиг будет выглядеть следующим образом:\nglobal:\n# Интервал сбора метрик (по умолчанию — 15 секунд);\nscrape_interval:\n15s\n# Интервал сверки с правилами (по умолчанию — 15 секунд);\nevaluation_interval:\n15s\n# Время ожидания (тайм-аут) выполнения запроса метрик.\n#scrape_timeout: 10s\n# Файлы правил\n#rule_files:\nscrape_configs:\n# Задание сбора данных самой службы\n# имя задачи\n-\njob_name:\n'lowcode'\n# Интервал сбора метрик (в приведённом случае — каждые 15 секунд);\nscrape_interval:\n15s\n# Время ожидания (тайм-аут) выполнения запроса метрик.\n#scrape_timeout: 10s\n# Путь к ресурсу HTTP, по которому можно получить метрики от целей.\nmetrics_path:\n/prometheus\n# Протокол для запросов - http | https\nscheme:\nhttp\n# Настройки basic-аутентификации\n# password и password_file исключают друг друга.\n#basic_auth:\n# Логин\n#username: <string>\n# Пароль\n#password: <secret>\n# Файл с паролем\n#password_file: <string>\nstatic_configs:\n-\ntargets:\n['АДРЕС_ПРИЛОЖЕНИЯ:ПОРТ_ПРИЛОЖЕНИЯ']\n# Если приложение работает по https\n# - targets: ['АДРЕС_ПРИЛОЖЕНИЯ']\nyaml\nCopied!\n1.5. Настройка Grafana для отображения метрик\nНужно настроить\nисточник данных\n(Data sources), выбрав базу данных\nPrometheus\n,\nгде нужно настроить\nсоединение\n(Connection) в таком виде\nhttp://АДРЕС\n_PROMETHEUS:9090\nasciidoc\nCopied!\nИмпортировать шаблон дашборда.\nШаблон можно скачать тут\nhttps://downloads.greendatasoft.ru/grafana/\nПосле импорта дашборда, данные из\nPrometheus\nподставятся автоматически.\n1.6. Garbage Collector\nЭто процесс, который автоматически находит и удаляет объекты,\nкоторые больше не используются вашим приложением.\nЧтобы включить сбор статистики GC, нужно добавить следующий параметр в\nстроку\nJAVA_OPTS\nконфигурационного файла контейнера docker-compose.yml,\nпример конфигурации выглядит так:\n-Xlog:gc*=info:file=/gc.log:time,uptime\nshell\nCopied!\n1.7. Основные метрики приложения\n1.7.1. Метрики JVM\nprocess_cpu_usage\n- Потребление CPU JVM\njvm_memory_committed_bytes\n- Размер памяти, выделенный jvm для работы\njvm_memory_max_bytes\n- Максимальный размер памяти, которую jvm может использовать\njvm_memory_used_bytes\n- Размер используемой памяти внутри выделенной\njvm_gc_overhead_percent\n- Приблизительный процент времени использования CPU GC\n1.7.2. Метрики пула подключений к БД\nhikaricp_connections_acquire_seconds_count\n- Время установления соединения в секундах\nhikaricp_connections\n- Количество подключений\nhikaricp_connections_pending\n- Количество ожиданий соединения\nhikaricp_connections_active\n- Количество активных соединений\nhikaricp_connections_max\n- Максимальное кол-во соединений\n1.7.3. Метрики исполнителей потоков\nexecutor_active_threads\n{name=\"executorName\",} - количество потоков, которые активно выполняют задачи\nexecutor_completed_tasks_total\n{name=\"executorName\",} - общее количество задач, выполнение которых завершено\nexecutor_queued_tasks\n{name=\"executorName\",} - количество задач, поставленных в очередь на выполнение\nexecutor_queue_remaining_tasks\n{name=\"executorName\",} - количество дополнительных элементов, которые очередь может принимать без блокировки\nexecutor_pool_max_threads\n{name=\"executorName\",} - максимально допустимое количество потоков в пуле\nexecutor_pool_core_threads\n{name=\"executorName\",} - основное количество потоков для пула\nexecutor_pool_size_threads\n{name=\"executorName\",} - текущее количество потоков в пуле\nЗначение параметра\nname\n- имя исполнителя потоков.\nКаждый исполнитель потоков отвечает за выполнение определенного набора задач. В системе существуют следующие исполнители:\nbatchStorageCompletionExecutor - сохранение/удаление файлов из хранилищ файлов внутри составного хранилища\nworkflowTaskExecutor - выполнение бизнес-процессов\nalgExecutor - выполнение алгоритмов\nauditExecutor - заполнение аудита\netlExecutor - запуск etl\ntaskScheduler - отложенное выполнение задач\nmessageBrokerTaskScheduler - планирование задач, связанных с обработкой сообщений в брокере\nclientOutboundChannelExecutor - обработка исходящих сообщений по WebSocket\nclientInboundChannelExecutor - обработка входящих сообщений по WebSocket\nbrokerChannelExecutor - обработка сообщений через брокер сообщений\ntaskExecutor - прочие задачи, требующие ассинхронного выполнения\n1.8. Рекомендуемые параметры для предупреждения\n/health\nне равно \"UP\";\nЗначение\nhikaricp_connections_active\nприближается к\nhikaricp_connections_max\n,\nразница меньше 10%;\njvm_memory_used_bytes\n(сумма\njvm_memory_used_bytes\n, у которых area = heap) постоянно\nзанимает более 90% от\njvm_memory_max_bytes\n(сумма\njvm_memory_max_bytes\n, у которых\narea = heap);\nЗначение\njvm_gc_overhead_percent\n> 80%;\nЗначение\nexecutor_active_threads\nсоставляет не более 80% от значения\nexecutor_pool_max_threads\n(для всех метрик КРОМЕ\nname=\"algExecutor\");\nЗначение\nexecutor_queued_tasks\nдолжна быть не больше 20% от значения\nexecutor_pool_max_threads\n(для всех метрик КРОМЕ\nname=\"algExecutor\").\n2. Мониторинг системы\nДля всех серверов промышленного контура (приложений, redis, СУБД)\nрекомендуется настроить мониторинг следующих параметров:\nСвободной оперативной памяти RAM;\nУтилизации CPU;\nСвободного дискового пространства;\nCкорость чтения/записи на диск;\nСредняя длина очереди чтения/записи диска;\nРекомендуются параметры предупреждения для серверов\nУтилизация CPU > 85% на протяжении продолжительного времени (60 минут);\nСвободного дискового пространства < 20%.\nРекомендуемые параметры предупреждения для СУБД\nДлинные блокировки больше 1 часа;\nАктуальность вакуума и статистики по всем сущностям БД приложения.\nНе должно быть вакуума и статистики старше 3х дней при наличии изменений в сущности.\nМониторинг свободного места в файлах tablespace c\nпредупреждением о свободном месте меньше 20%.",
  "source": "https://docs.greendata.ru/platform/ru/monitoring.html"
}