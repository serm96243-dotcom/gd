{
  "title": "getExternalUserProviderContext",
  "text": "Была ли статья полезной?\nДа\nНет\nСпасибо за вашу оценку!\nОставляя более подробный отзыв, вы помогаете нам улучшать документацию\nКомментарий к оценке\nКонтактная информация (необязательно)\nВложения\nДобавить файл\nОтменить\nОтправить\ngetExternalUserProviderContext\nФункция используется для получения данных сотрудника, который выполняет вход в систему через провайдер идентификации.\nФункция предназначена исключительно для настройки\nсобытий до и после авторизации пользователя\n.\nСинтаксис\ngetExternalUserProviderContext\n()\nПараметры отсутствуют.\nПримечание\nВызов функции осуществляется с вкладки\n\"Интеграция\"\nпанели инструментов редактора алгоритмов.\nФункция возвращает объект, который доступен только в момент авторизации пользователя на платформе.\nПри работе с функцией можно использовать методы:\ngetAuthenticationProviderData – получение данных из внешнего провайдера в виде класса HashMap;\nК полученному объекту можно применить методы put, remove, get, containsKey, size, isEmpty и т.д.\nНапример, с помощью метода get можно получить следующие атрибуты:\n\"mail\" – электронная почта пользователя;\n\"givenname\" – имя пользователя;\n\"badpwdcount\" – количество попыток входа пользователя с неправильным паролем;\n\"whenchanged\" – дата последнего изменения объекта;\n\"countrycode\" – код страны для выбранного пользователем языка,\nа также другие атрибуты в соответствии с\nдокументацией\n.\naddExternalGroup – добавление внешних групп пользователю, ничего не возвращает;\nremoveExternalGroup – удаление внешних групп у пользователя, ничего не возвращает;\ngetDomainName – получение имени домена пользователя, осуществляющего вход в приложение (применимо только для\nтипа провайдера идентификации \"Доменная аутентификация\"\n).\nПри настройке\nсобытия после авторизации пользователя\nданные из внешнего провайдера доступны\nтолько для чтения\n, поэтому использование методов addExternalGroup, removeExternalGroup и getAuthenticationProviderData с применением методов put, remove и т.д. будет сопровождаться ошибкой, которая будет отображена в логе выполнения алгоритма.\nПримеры\nПример №1. Событие до авторизации\nДопустим, пользователь осуществляет вход в приложение GreenData, используя учетные данные домена \"domain_1\" (полный путь DC=domain_1,DC=local) или \"domain_2\" (полный путь DC=domain_2,DC=local).\nПользователям из \"domain_2\" назначаются группы в \"domain_1\". При входе пользователя из \"domain_2\" приложение должно учитывать назначенные ему роли в \"domain_1\" и выдавать\nгруппы доступа\nв соответствии с настроенными\nсвязями с внешними группами\n.\nПредполагается, что:\nНастроена аутентификация через LDAP или Kerberos+LDAP для доменов \"domain_1\" и \"domain_2\" (подробнее в статьях\n\"Настройка доменной аутентификации по протоколу LDAP\"\nи\n\"Развертывание приложения с SPNEGO и Kerberos аутентификацией на серверах с ОС Linux\"\n).\nДля групп доступа внешних доменов настроены связи с группами доступа в приложении GreenData (подробнее,\n\"Настройка доменной аутентификации по протоколу LDAP\"\n).\nДля домена \"domain_1\" создан экземпляр типа \"Настройки подключения LDAP\" (подробнее,\n\"Интеграция с Microsoft Active Directory\"\n).\nДля этого необходимо в провайдере идентификации  \"Доменная аутентификация\" настроить\nсобытие до авторизации\n, в котором добавить алгоритм следующего вида:\nСуть алгоритма в том, что для пользователя, осуществляющего аутентификацию по учетным данным домена \"domain_2\", необходимо сделать запрос в \"domain_1\" и получить назначенные пользователю роли.\nКод алгоритма\n//Получение данных пользователя, который входит в приложение\ndef\nuserProviderContext = getExternalUserProviderContext()\ndef\nldapData = userProviderContext.getAuthenticationProviderData()\n// если пользователь из домена domain_1, то алгоритм завершает работу (дополнительных действий не требуется, группы доступа пользователю назначаются только из domain_1)\ndef\ndomainName = userProviderContext.getDomainName()\nif\n(domainName =\n\"domain_1\"\n) {\nreturn\n}\n//получение атрибута objectSid, по которому происходит назначение групп доступа из домена domain_1\ndef\nobjectSidString = convertLdapObjectSidToString(ldapData[\n\"objectSid\"\n].getBytes)\n//получение строки для поиска в domain_1\n//пример результата: CN=S-1-5-21-731729372-2948062554-3417547452-1225, CN=ForeignSecurityPrincipals,DC=domain_1,DC=local\ndef\nforeignPrincipalCn =\n\"CN=\"\n+ objectSidString +\n\",CN=ForeignSecurityPrincipals,DC=domain_1,DC=local\"\n// поиск групп в домене domain_1, в которых состоит пользователь\n// ou=Groups,ou=Root - это контейнер с группами в домене domain_1\ndef\ngroupEntries = searchLdapEntry(\n<ID экземпляра типа\n\"Настройки подключения LDAP\"\nдля домена domain_1>,\nldapSearchOptions()\n. subtree()\n. base(\n\"ou=Groups,ou=Root\"\n)\n. filter(\n\"(&(objectClass=group)(member=\"\n+ foreignPrincipalCn +\n\"))\"\n)\n. attributes([\n\"cn\"\n])\n)\n// обработка списка групп доступа, полученных из домена domain_1 и назначение их пользователю приложения Greendata\nfor\n(\ndef\ngroup :\ngroupEntries) {\nuserProviderContext.addExternalGroup(group[\n\"cn\"\n].get(\n0\n))\n}\ngroovy\nCopied!\nID экземпляра типа \"Настройки подключения LDAP\" вставляется в алгоритм при помощи функции\ndict\n.\nПри создании события до авторизации через меню действий параметра в код алгоритма подставляется шаблон с кратким описанием и использованием функции\ngetExternalUserProviderContext\n, который необходимо изменить в соответствии с поставленной задачей.\nНастройка\nсобытия до авторизации\nпозволит при доменной аутентификации пользователя в приложении получить его данные из внешнего провайдера \"domain_1\" и использовать их при обращении к внешнему провайдеру \"domain_2\".\nНа основании полученных групп Система выдает необходимые роли в приложении, после чего осуществляется авторизация пользователя.\nПример №2. Событие после авторизации\nПредположим, требуется настроить отправку сообщения пользователю при его авторизации в приложении.\nДля этого в провайдере идентификации \"Доменная аутентификация\" необходимо настроить\nсобытие после авторизации\n, в котором добавить алгоритм следующего вида:\nПосредством функции\ngetExternalUserProviderContext\nс использованием методов \"getAuthenticationProviderData\" и \"get\" осуществляется получение электронной почты пользователя (атрибут \"mail\") из внешнего провайдера.\nДля написания данного алгоритма также были использованы другие функции.\nПеременные объявлены посредством функции\nvar\n.\nДля отправки сообщения на электронную почту используется функция\nsendMsgToEmail\n, в качестве третьего параметра которой с помощью функции\ncurrentUser\nустанавливается Код текущего пользователя.\nВ результате настройки при успешной доменной аутентификации в приложении пользователь получит письмо в соответствии с настроенным\nшаблоном уведомления\n:",
  "source": "https://docs.greendata.ru/platform/ru/getexternaluserprovidercontext.html"
}